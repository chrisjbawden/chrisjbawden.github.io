<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chris Bawden - Portfolio</title>
  <link rel="stylesheet" href="/stylesheets/styles.css">

  <!-- PDF.js Library -->
  <script src="https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
</head>
<body>
  <div class="wrapper">
    <div id="sidebar-placeholder"></div>

        </script>

    <section style="padding-top:10%;">
      <div id="pdf-container"></div>

      <script>
        // ===== CONFIG =====
        const OWNER  = "chrisjbawden";
        const REPO   = "chrisjbawden.github.io";
        // Try common default branches in order
        const BRANCHES = ["main", "master"];

        const CERT_DIR = "portfolio/certificates";
        const BADGE_DIR = "portfolio/badges";
        const TERT_DIR  = "portfolio/tertiary";

        const PDF_EXT = new Set([".pdf"]);
        const IMG_EXT = new Set([".png", ".jpg", ".jpeg", ".webp", ".gif", ".svg"]);

        // PDF.js worker
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.worker.min.js';

        // Helpers
        const getExt = (name) => {
          const i = name.lastIndexOf(".");
          return i === -1 ? "" : name.slice(i).toLowerCase();
        };

        // Encode each path segment but keep "/" separators
        const encodePath = (p) => p.split("/").map(encodeURIComponent).join("/");

        // Show a small inline notice if a directory is missing
        const showMissingDirNote = (path, status) => {
          const pdfContainer = document.getElementById('pdf-container');
          const note = document.createElement('p');
          note.textContent = `Couldn’t load “/${path}” (HTTP ${status}). Check the folder name/branch exists in the repo.`;
          pdfContainer.appendChild(note);
        };

        // List files from GitHub API and return both rawUrl (direct from repo) and site path
        const listDir = async (path) => {
          const encPath = encodePath(path);

          for (const branch of BRANCHES) {
            const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encPath}?ref=${encodeURIComponent(branch)}`;
            console.debug("GitHub API URL:", url);

            const res = await fetch(url);
            if (res.ok) {
              const items = await res.json();
              return items
                .filter(x => x.type === "file")
                .map(x => ({
                  name: x.name,
                  sitePath: `/${path}/${x.name}`, // published site path (not used now, but kept in case)
                  rawUrl: x.download_url,         // direct file from repo (no Pages rebuild needed)
                  _ext: getExt(x.name)
                }));
            } else {
              console.warn(`listDir: ${path} on branch "${branch}" -> ${res.status}`);
              if (branch === BRANCHES[BRANCHES.length - 1]) {
                showMissingDirNote(path, res.status);
              }
            }
          }
          return [];
        };

        const generateThumbnail = (file, container) => {
          const isBadge = file.category === "Badges";
          const isPdf = PDF_EXT.has(file._ext);

          if (isBadge && IMG_EXT.has(file._ext)) {
            // Badges: show image only (no filename)
            const div = document.createElement('div');
            div.classList.add('thumbnail');

            const img = document.createElement('img');
            img.src = file.rawUrl;   // load directly from repo
            img.alt = file.name;
            img.style.width = '150px';
            img.style.height = '150px';
            img.loading = 'lazy';

            div.appendChild(img);
            container.appendChild(div);
            return;
          }

          if (isPdf) {
            // Render first page thumbnail via PDF.js using raw URL (direct from repo)
            const loadingTask = pdfjsLib.getDocument(file.rawUrl);
            loadingTask.promise.then(function(pdf) {
              pdf.getPage(1).then(function(page) {
                const scale = 0.3;
                const viewport = page.getViewport({ scale });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                const renderContext = { canvasContext: context, viewport };
                page.render(renderContext).promise.then(function() {
                  const div = document.createElement('div');
                  div.classList.add('thumbnail');

                  const link = document.createElement('a');
                  link.href = file.rawUrl;   // open raw PDF directly
                  link.target = '_blank';
                  link.rel = 'noopener';
                  link.appendChild(canvas);

                  const text = document.createElement('span');
                  text.innerText = file.name.replace(/\.[^.]+$/, "");

                  div.appendChild(text);
                  div.appendChild(link);
                  container.appendChild(div);
                });
              });
            }).catch(() => {
              // Fallback link if PDF rendering fails
              const div = document.createElement('div');
              div.classList.add('thumbnail');
              const a = document.createElement('a');
              a.href = file.rawUrl;
              a.target = '_blank';
              a.rel = 'noopener';
              a.innerText = file.name.replace(/\.[^.]+$/, "") + " (PDF)";
              div.appendChild(a);
              container.appendChild(div);
            });
            return;
          }

          // Fallback for unknown types — link to raw file
          const div = document.createElement('div');
          div.classList.add('thumbnail');

          const img = document.createElement('img');
          img.src = 'https://via.placeholder.com/100x150?text=File';
          img.alt = 'File Thumbnail';
          img.style.width = '150px';
          img.style.height = '150px';

          const link = document.createElement('a');
          link.href = file.rawUrl;
          link.target = '_blank';
          link.rel = 'noopener';
          link.innerText = file.name.replace(/\.[^.]+$/, "");

          div.appendChild(img);
          div.appendChild(link);
          container.appendChild(div);
        };

        (async () => {
          const pdfContainer = document.getElementById('pdf-container');

          // Fetch directories in parallel (from repo API)
          const [certs, badges, tertiary] = await Promise.all([
            listDir(CERT_DIR),
            listDir(BADGE_DIR),
            listDir(TERT_DIR)
          ]);

          const files = [
            ...certs.map(f => ({ ...f, category: "Certificates" })),
            ...badges.map(f => ({ ...f, category: "Badges" })),
            ...tertiary.map(f => ({ ...f, category: "Tertiary" }))
          ];

          // Group by category
          const categories = {};
          for (const f of files) {
            if (!categories[f.category]) categories[f.category] = [];
            categories[f.category].push(f);
          }

          // Render each category section
          for (const [category, group] of Object.entries(categories)) {
            const categoryDiv = document.createElement('div');
            categoryDiv.classList.add('category');

            const title = document.createElement('h3');
            title.classList.add('category-title'); // assume centred in your CSS
            title.innerText = category;
            categoryDiv.appendChild(title);

            const container = document.createElement('div');
            container.classList.add('thumbnail-container');
            categoryDiv.appendChild(container);

            group.forEach(file => generateThumbnail(file, container));

            pdfContainer.appendChild(categoryDiv);
          }

          // If nothing found, show a gentle message
          if (!files.length) {
            const note = document.createElement('p');
            note.textContent = "No items found yet. Add files to /portfolio/certificates, /portfolio/badges, or /portfolio/tertiary.";
            pdfContainer.appendChild(note);
          }
        })();
      </script>


    </section>

    <footer>
      <p><span>Projects maintained by </span>
        <script>
          var s="=b!isfg>#nbjmup;disjtkcbxefoApvumppl/dpn#?Disjt!Cbxefo=0b?";
          var m=""; for(var i=0;i<s.length;i++) m+=String.fromCharCode(s.charCodeAt(i)-1);
          document.write(m);
        </script>
        <noscript>You must enable JavaScript to see this text.</noscript>
      </p>
      <p><small>Hosted with GitHub Pages — Link to <a href="https://chrisjbawden.github.io/blog/blog.html#instructions">instructions</a></small></p>
    </footer>
  </div>

  <script src="/javascripts/scale.fix.js"></script>
</body>
</html>
