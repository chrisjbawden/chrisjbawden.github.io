<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Scored Chess Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <link rel="stylesheet" href="./chessboard-1.0.0.min.css"/>
  <style>
    html,body {
      margin:0; padding:0;
      width:100%; height:100%;
      font-family:'Segoe UI',sans-serif;
      background:#f4f4f4;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    #container {
      width:90vw; max-width:700px;
      display:flex; flex-direction:column;
      align-items:center;
    }
    #board {
      width:100%;
      display:none;
      touch-action:none;
    }
    #scoreBoard {
      margin-top:12px;
      font-size:1rem;
      text-align:center;
      display:none;
    }
    #colorButtons {
      margin-bottom:16px;
    }
    #colorButtons button {
      padding:10px 18px; margin:0 8px;
      font-size:1rem;
      border:none; border-radius:6px;
      background:#0077cc; color:#fff;
      cursor:pointer; transition:background 0.3s;
    }
    #colorButtons button:hover {
      background:#005fa3;
    }
    .highlight {
      background:rgba(255,235,59,0.6) !important;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="colorButtons">
      <button onclick="startGame('white')">White</button>
      <button onclick="startGame('black')">Black</button>
    </div>
    <div id="board"></div>
    <div id="scoreBoard">Select a piece to move</div>
  </div>

  <script src="./jquery-3.6.0.min.js"></script>
  <script src="./chess.min.js"></script>
  <script src="./chessboard-1.0.0.min.js"></script>
  <script>
    let board, game, stockfish, playerColor;
    let sourceSquare = null;

    function startGame(color) {
      playerColor = color;
      $('#colorButtons').hide();
      $('#board').show();
      $('#scoreBoard').show().text('Select a piece to move');
      initGame();
    }

    function initGame() {
      game = new Chess();
      stockfish = new Worker('stockfish.js');
      board = Chessboard('board', {
        position: 'start',
        draggable: false,
        orientation: playerColor,
        pieceTheme: '{piece}.png'
      });
      // handle clicks on any square
      $('#board').off('click').on('click', '[data-square]', onSquareClick);
      // if black, let stockfish go first
      if (playerColor === 'black') {
        setTimeout(botMove, 300);
        $('#scoreBoard').text('Stockfish opening...');
      }
    }

    function onSquareClick() {
      const sq = $(this).attr('data-square');
      // first click: select your piece
      if (!sourceSquare) {
        const pc = game.get(sq);
        if (!pc || pc.color !== playerColor[0]) return;
        sourceSquare = sq;
        highlightSquare(sq);
        $('#scoreBoard').text('Select destination');
      } else {
        // second click: attempt move
        const dest = sq;
        const oldFen = game.fen();
        const move = game.move({ from: sourceSquare, to: dest, promotion: 'q' });
        clearHighlights();
        sourceSquare = null;
        if (!move) {
          board.position(game.fen());
          $('#scoreBoard').text('Illegal move, pick again');
          return;
        }
        board.position(game.fen());
        scoreUserMove(oldFen, move);
        if (!game.game_over()) {
          setTimeout(botMove, 500);
        } else {
          showGameOver();
        }
      }
    }

    function highlightSquare(sq) {
      clearHighlights();
      $(`.square-${sq}`).addClass('highlight');
    }

    function clearHighlights() {
      $('#board [class*="square-"]').removeClass('highlight');
    }

    function scoreUserMove(fen, userMove) {
      const temp = new Chess(fen);
      const legal = temp.moves({ verbose: true });
      const results = [];
      let done = 0;
      const depth = 5;

      legal.forEach(mv => {
        const g2 = new Chess(fen);
        g2.move(mv);
        const fen2 = g2.fen();
        const handler = e => {
          if (e.data.startsWith('info') && e.data.includes('score cp')) {
            const mm = e.data.match(/score cp (-?\\d+)/);
            if (mm) results.push({ move: mv, score: +mm[1] });
            done++;
            if (done === legal.length) {
              stockfish.removeEventListener('message', handler);
              displayScore(results, userMove);
            }
          }
        };
        stockfish.addEventListener('message', handler);
        stockfish.postMessage("position fen " + fen2);
        stockfish.postMessage("go depth " + depth);
      });
    }

    function displayScore(results, userMove) {
      results.sort((a,b)=>b.score - a.score);
      const best = results[0].score;
      const worst = results[results.length-1].score;
      const found = results.find(r =>
        r.move.from === userMove.from && r.move.to === userMove.to
      );
      const raw = found ? found.score : worst;
      const norm = (best === worst)
        ? 0
        : Math.round((raw - worst) / (best - worst) * 100);
      $('#scoreBoard').html(`Your move score: <strong>${norm}</strong>`);
    }

    function botMove() {
      const depth = 5;
      const handler = e => {
        if (e.data.startsWith('bestmove')) {
          const mv = e.data.split(' ')[1];
          if (mv && mv !== '(none)') {
            game.move({ from: mv.substr(0,2), to: mv.substr(2,2), promotion: 'q' });
            board.position(game.fen());
          }
          stockfish.removeEventListener('message', handler);
          if (game.game_over()) {
            showGameOver();
          } else {
            $('#scoreBoard').text('Your turn: select a piece');
          }
        }
      };
      stockfish.addEventListener('message', handler);
      stockfish.postMessage("position fen " + game.fen());
      stockfish.postMessage("go depth " + depth);
    }

    function showGameOver() {
      const res = game.in_checkmate()
        ? (game.turn() === playerColor[0] ? 'You lost!' : 'You won!')
        : 'Draw!';
      $('#scoreBoard').html(`<strong>${res}</strong><br><button onclick="location.reload()">Restart</button>`);
    }
  </script>
</body>
</html>
