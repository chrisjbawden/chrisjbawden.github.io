<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hidden Choice Chess</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stockfish@11.0.0/stockfish.asm.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard.min.css" />
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    #board { width: 400px; margin: 20px auto; }
    #choices { margin-top: 20px; }
    button.move-choice { margin: 5px; padding: 10px 20px; font-size: 1.2em; }
  </style>
</head>
<body>
  <h1>Hidden Choice Chess</h1>
  <div id="board"></div>
  <div id="choices"></div>
  <script>
    const game = new Chess();
    const board = Chessboard('board', {
      position: 'start',
      draggable: false
    });

    const stockfish = new Worker('https://cdn.jsdelivr.net/npm/stockfish@11.0.0/stockfish.asm.js');

    function stockfishEval(fen, callback) {
      let handler = function(event) {
        if (event.data.includes("score cp")) {
          stockfish.removeEventListener("message", handler);
          const match = event.data.match(/score cp (-?\\d+)/);
          const score = match ? parseInt(match[1]) : 0;
          callback(score);
        }
      };
      stockfish.addEventListener("message", handler);
      stockfish.postMessage("position fen " + fen);
      stockfish.postMessage("go depth 6");
    }

    function getMoveEval(move, callback) {
      game.move(move);
      const fen = game.fen();
      game.undo();
      stockfishEval(fen, score => callback({ move, score }));
    }

    function showChoices() {
      const moves = game.moves({ verbose: true });
      const scored = [];

      let evaluated = 0;
      for (let move of moves) {
        getMoveEval(move, result => {
          scored.push(result);
          evaluated++;
          if (evaluated === moves.length) {
            scored.sort((a, b) => b.score - a.score);
            const best = scored[0];
            const worst = scored[scored.length - 1];
            const options = Math.random() < 0.5 ? [best, worst] : [worst, best];

            const choicesDiv = document.getElementById("choices");
            choicesDiv.innerHTML = "<p>Pick your move:</p>";
            options.forEach(opt => {
              const btn = document.createElement("button");
              btn.textContent = opt.move.san;
              btn.className = "move-choice";
              btn.onclick = () => {
                game.move(opt.move.san);
                board.position(game.fen());
                choicesDiv.innerHTML = "";
                setTimeout(botMove, 200);
              };
              choicesDiv.appendChild(btn);
            });
          }
        });
      }
    }

    function botMove() {
      const fen = game.fen();
      stockfish.onmessage = function(event) {
        if (event.data.startsWith("bestmove")) {
          const move = event.data.split(" ")[1];
          game.move({ from: move.slice(0, 2), to: move.slice(2, 4), promotion: 'q' });
          board.position(game.fen());
          showChoices();
        }
      };
      stockfish.postMessage("position fen " + fen);
      stockfish.postMessage("go depth 4");
    }

    // Start game
    showChoices();
  </script>
</body>
</html>
