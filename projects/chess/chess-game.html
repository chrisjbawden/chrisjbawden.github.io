<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scored Chess Game</title>
  <link rel="stylesheet" href="./chessboard-1.0.0.min.css" />
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #f4f4f4;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #board {
      width: 90vw;
      max-width: 90vmin;
    }

    #scoreBoard {
      margin-top: 20px;
      font-size: 18px;
      text-align: center;
    }

    #scoreBoard span {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="board"></div>
  <div id="scoreBoard">Make a move to receive a score.</div>

  <script src="./jquery-3.6.0.min.js"></script>
  <script src="./chess.min.js"></script>
  <script src="./chessboard-1.0.0.min.js"></script>
  <script>
    const boardEl = document.getElementById('board');
    const scoreEl = document.getElementById('scoreBoard');

    const game = new Chess();
    const stockfish = new Worker('stockfish.js');

    let board = Chessboard('board', {
      draggable: true,
      position: 'start',
      onDrop: onDrop,
      pieceTheme: '{piece}.png'
    });

    function onDrop(source, target) {
      const move = game.move({ from: source, to: target, promotion: 'q' });
      if (move === null) return 'snapback';

      board.position(game.fen());
      scoreUserMove(move);

      setTimeout(botMove, 500);
    }

    function botMove() {
      stockfish.postMessage("position fen " + game.fen());
      stockfish.postMessage("go depth 5");
      stockfish.onmessage = function(e) {
        if (e.data.startsWith("bestmove")) {
          const move = e.data.split(" ")[1];
          if (move === "(none)") return;

          game.move(move, { sloppy: true });
          board.position(game.fen());

          if (game.game_over()) {
            const msg = game.in_checkmate() ? "You lost!" : "Draw!";
            scoreEl.innerHTML = `<span>${msg}</span>`;
          }
        }
      };
    }

    function scoreUserMove(playerMove) {
      const allMoves = game.history({ verbose: true });
      const lastMove = allMoves[allMoves.length - 1];

      const legalMoves = game.moves({ verbose: true });
      const scoredMoves = [];

      let completed = 0;

      function process(move, fen) {
        const handler = (e) => {
          if (e.data.startsWith("info") && e.data.includes("score cp")) {
            const match = e.data.match(/score (cp|mate) (-?\d+)/);
            if (match) {
              scoredMoves.push({
                move: move,
                score: parseInt(match[2])
              });
              completed++;
              if (completed === legalMoves.length) {
                stockfish.removeEventListener('message', handler);
                evaluatePlayerScore(scoredMoves, lastMove);
              }
            }
          }
        };
        stockfish.addEventListener('message', handler);
        stockfish.postMessage("position fen " + fen);
        stockfish.postMessage("go depth 5");
      }

      legalMoves.forEach(m => {
        const g = new Chess(game.fen());
        g.move(m);
        process(m, g.fen());
      });
    }

    function evaluatePlayerScore(scoredMoves, playerMove) {
      scoredMoves.sort((a, b) => b.score - a.score);

      const best = scoredMoves[0].score;
      const worst = scoredMoves[scoredMoves.length - 1].score;

      const moveScore = scoredMoves.find(m => m.move.from === playerMove.from && m.move.to === playerMove.to)?.score ?? worst;

      let normalised = 0;
      if (best !== worst) {
        normalised = Math.round(((moveScore - worst) / (best - worst)) * 100);
      }

      scoreEl.innerHTML = `Your move score: <span>${normalised}/100</span>`;
    }
  </script>
</body>
</html>
