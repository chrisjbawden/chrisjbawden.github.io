<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Timer</title>
    <style>
        /* Reset & base */
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 60px;
            background: #282c34;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10;
            box-shadow: 0 2px 6px rgb(0 0 0 / 0.3);
        }
        header h1 {
            font-size: 1.5rem;
            margin: 0;
            user-select: none;
        }
        #settingsButton {
            background: transparent;
            border: 2px solid white;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #settingsButton:hover {
            background-color: white;
            color: #282c34;
        }

        /* Main content area */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 80px 20px 60px; /* account for fixed header/footer */
            text-align: center;
            width: 100%;
        }

        #timer {
            font-size: 20vw;
            max-font-size: 300px;
            margin: 0 0 30px 0;
            user-select: none;
        }

        #controlPanel {
            display: flex;
            justify-content: center;
            gap: 20px;
            width: 100%;
            max-width: 400px;
        }
        button.control {
            flex: 1;
            min-width: 120px;
            padding: 15px 0;
            font-size: 5vw;
            min-height: 100px;
            cursor: pointer;
            background-color: #eee;
            border: 2px solid #ccc;
            border-radius: 10px;
            transition: background-color 0.3s ease;
            user-select: none;
        }
        button.control:hover {
            background-color: #ddd;
        }

        /* Start button */
        #startButton {
            padding: 20px 40px;
            font-size: 5vw;
            min-width: 200px;
            min-height: 120px;
            border-radius: 15px;
            border: none;
            background-color: #61dafb;
            color: #282c34;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
            user-select: none;
        }
        #startButton:hover {
            background-color: #21a1f1;
        }

        /* Usage Example Section */
        #usageExample {
            max-width: 600px;
            margin: 40px auto 0;
            padding: 15px 20px;
            background: #f0f8ff;
            border: 1px solid #61dafb;
            border-radius: 8px;
            color: #282c34;
            font-family: monospace;
            font-size: 1rem;
            user-select: none;
        }

        /* Footer */
        footer {
            height: 50px;
            background-color: #282c34;
            color: white;
            text-align: center;
            line-height: 50px;
            font-size: 0.9rem;
            user-select: none;
            width: 100%;
        }
        footer a {
            color: #61dafb;
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }

        /* Modal overlay */
        #modalOverlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        /* Modal content */
        #settingsModal {
            background: white;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            padding: 25px 30px;
            box-shadow: 0 5px 15px rgb(0 0 0 / 0.3);
            animation: fadeInScale 0.3s ease forwards;
        }
        @keyframes fadeInScale {
            from {opacity: 0; transform: scale(0.9);}
            to {opacity: 1; transform: scale(1);}
        }

        #settingsModal h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 700;
            user-select: none;
        }

        .inputGroup {
            margin-bottom: 15px;
            text-align: left;
        }
        .inputGroup label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }
        .inputRow {
            display: flex;
            gap: 10px;
        }
        input[type="number"] {
            width: 60px;
            padding: 8px;
            font-size: 1rem;
            border: 1.5px solid #ccc;
            border-radius: 6px;
            transition: border-color 0.3s ease;
        }
        input[type="number"]:focus {
            border-color: #61dafb;
            outline: none;
        }

        #modalButtons {
            margin-top: 25px;
            text-align: right;
        }
        #modalButtons button {
            padding: 8px 18px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            user-select: none;
        }
        #saveSettings {
            background-color: #61dafb;
            color: #282c34;
            margin-left: 10px;
        }
        #saveSettings:hover {
            background-color: #21a1f1;
        }
        #cancelSettings {
            background-color: #eee;
            color: #333;
        }
        #cancelSettings:hover {
            background-color: #ccc;
        }
    </style>
</head>
<body>
    <header>
        <h1>Timer</h1>
        <button id="settingsButton" aria-label="Open Settings">Settings ⚙️</button>
    </header>

    <main>
        <!-- Start button visible initially -->
        <button id="startButton">Start</button>

        <!-- Timer and controls hidden initially -->
        <div id="timer" style="display:none;">Initializing...</div>

        <div id="controlPanel" style="display:none;">
            <button id="pauseButton" class="control" onclick="pauseResumeTimer()">Pause</button>
            <button class="control" onclick="nextPhase()">Next</button>
        </div>

        <!-- Usage example hint -->
        <section id="usageExample">
            <strong>Usage Example:</strong><br />
            Use URL parameters like <code>?warmup=30s&highIntensity=1m&rest=45s</code> to set intervals.
        </section>
    </main>

    <footer>
        <a href="https://chrisjbawden.github.io" target="_blank" rel="noopener noreferrer">View on GitHub</a>
    </footer>

    <!-- Modal -->
    <div id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div id="settingsModal">
            <h2 id="modalTitle">Settings</h2>
            <form id="settingsForm" onsubmit="return false;">
                <div class="inputGroup">
                    <label for="warmupMinutes">Warmup Interval</label>
                    <div class="inputRow">
                        <input type="number" id="warmupMinutes" min="0" max="59" placeholder="Min" /> :
                        <input type="number" id="warmupSeconds" min="0" max="59" placeholder="Sec" />
                    </div>
                </div>
                <div class="inputGroup">
                    <label for="highIntensityMinutes">High Intensity Interval</label>
                    <div class="inputRow">
                        <input type="number" id="highIntensityMinutes" min="0" max="59" placeholder="Min" /> :
                        <input type="number" id="highIntensitySeconds" min="0" max="59" placeholder="Sec" />
                    </div>
                </div>
                <div class="inputGroup">
                    <label for="restMinutes">Rest Interval</label>
                    <div class="inputRow">
                        <input type="number" id="restMinutes" min="0" max="59" placeholder="Min" /> :
                        <input type="number" id="restSeconds" min="0" max="59" placeholder="Sec" />
                    </div>
                </div>
                <div id="modalButtons">
                    <button id="cancelSettings" type="button">Cancel</button>
                    <button id="saveSettings" type="submit">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Audio element for the beep sound -->
    <audio id="beepSound" src="beep.mp3"></audio>

<script>
    let timerInterval;
    let currentPhase = 'warmup';
    let isPaused = false;
    let timerRunning = false;

    // Default durations in seconds (set to 60s each)
    const originalDurations = {
        warmup: 60,
        highIntensity: 60,
        rest: 60
    };

    const phases = {
        warmup: { duration: 0, next: 'highIntensity', color: '#FFCCCC' },
        highIntensity: { duration: 0, next: 'rest', color: '#DFF2BF' },
        rest: { duration: 0, next: 'highIntensity', color: '#FFFACD' }
    };

    // Parse time string like "30s" or "1m"
    function parseTime(input) {
        if (!input) return 0;
        const num = parseInt(input.slice(0, -1), 10);
        const unit = input.slice(-1);
        return unit === 's' ? num : num * 60;
    }

    // Load from URL or localStorage or use defaults
    function loadDurations() {
        const urlParams = new URLSearchParams(window.location.search);

        // Start with defaults 60 seconds
        let warmup = 60;
        let high = 60;
        let rest = 60;

        // Override with URL params if present
        if(urlParams.has('warmup')) warmup = parseTime(urlParams.get('warmup'));
        if(urlParams.has('highIntensity')) high = parseTime(urlParams.get('highIntensity'));
        if(urlParams.has('rest')) rest = parseTime(urlParams.get('rest'));

        // Override with saved settings if exist (localStorage)
        const stored = localStorage.getItem('timerSettings');
        if(stored) {
            try {
                const obj = JSON.parse(stored);
                if(typeof obj.warmup === 'number') warmup = obj.warmup;
                if(typeof obj.highIntensity === 'number') high = obj.highIntensity;
                if(typeof obj.rest === 'number') rest = obj.rest;
            } catch {}
        }

        originalDurations.warmup = warmup;
        originalDurations.highIntensity = high;
        originalDurations.rest = rest;
    }

    // Setup timer durations and initial state (does NOT start timer)
    function setupTimer() {
        loadDurations();
        resetPhases();
        currentPhase = phases.warmup.duration > 0 ? 'warmup' : 'highIntensity';
        updateTimerDisplay();
        updateBackgroundColor();
    }

    function resetPhases() {
        phases.warmup.duration = originalDurations.warmup;
        phases.highIntensity.duration = originalDurations.highIntensity;
        phases.rest.duration = originalDurations.rest;
    }

    function timerTick() {
        if (!isPaused && phases[currentPhase].duration > 0) {
            phases[currentPhase].duration--;
            updateTimerDisplay();
        } else if (!isPaused) {
            nextPhase();
        }
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(phases[currentPhase].duration / 60);
        const seconds = phases[currentPhase].duration % 60;
        const formattedTime =
            (minutes < 10 ? "0" + minutes : minutes) + ":" +
            (seconds < 10 ? "0" + seconds : seconds);
        document.getElementById('timer').textContent = formattedTime;
    }

    function pauseResumeTimer() {
        if(!timerRunning) return;
        isPaused = !isPaused;
        document.getElementById('pauseButton').textContent = isPaused ? 'Resume' : 'Pause';
    }

    function nextPhase() {
        playBeep();
        currentPhase = phases[currentPhase].next;
        phases[currentPhase].duration = originalDurations[currentPhase]; // Reset the duration for the new phase
        updateTimerDisplay();
        updateBackgroundColor();
    }

    function playBeep() {
        const beepSound = document.getElementById('beepSound');
        beepSound.play();
    }

    function updateBackgroundColor() {
        document.body.style.backgroundColor = phases[currentPhase].color;
    }

    // Start button handler
    const startButton = document.getElementById('startButton');
    const timerDisplay = document.getElementById('timer');
    const controlPanel = document.getElementById('controlPanel');

    startButton.addEventListener('click', () => {
        // Hide start button
        startButton.style.display = 'none';

        // Show timer and controls
        timerDisplay.style.display = 'block';
        controlPanel.style.display = 'flex';

        // Setup timer and start ticking
        setupTimer();
        isPaused = false;
        document.getElementById('pauseButton').textContent = 'Pause';

        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(timerTick, 1000);
        timerRunning = true;
    });

    // Settings modal handlers
    const modalOverlay = document.getElementById('modalOverlay');
    const settingsButton = document.getElementById('settingsButton');
    const cancelSettings = document.getElementById('cancelSettings');
    const saveSettings = document.getElementById('saveSettings');
    const settingsForm = document.getElementById('settingsForm');

    settingsButton.addEventListener('click', openSettingsModal);
    cancelSettings.addEventListener('click', closeSettingsModal);
    settingsForm.addEventListener('submit', saveSettingsHandler);

    function openSettingsModal() {
        function toMinSec(totalSeconds) {
            const m = Math.floor(totalSeconds / 60);
            const s = totalSeconds % 60;
            return { m, s };
        }
        let warmup = toMinSec(originalDurations.warmup);
        let high = toMinSec(originalDurations.highIntensity);
        let rest = toMinSec(originalDurations.rest);

        document.getElementById('warmupMinutes').value = warmup.m;
        document.getElementById('warmupSeconds').value = warmup.s;
        document.getElementById('highIntensityMinutes').value = high.m;
        document.getElementById('highIntensitySeconds').value = high.s;
        document.getElementById('restMinutes').value = rest.m;
        document.getElementById('restSeconds').value = rest.s;

        modalOverlay.style.display = 'flex';
    }

    function closeSettingsModal() {
        modalOverlay.style.display = 'none';
    }

    function saveSettingsHandler(e) {
        e.preventDefault();

        function getTime(idMin, idSec) {
            let min = parseInt(document.getElementById(idMin).value) || 0;
            let sec = parseInt(document.getElementById(idSec).value) || 0;
            if (min < 0) min = 0; if (min > 59) min = 59;
            if (sec < 0) sec = 0; if (sec > 59) sec = 59;
            return min * 60 + sec;
        }

        originalDurations.warmup = getTime('warmupMinutes', 'warmupSeconds');
        originalDurations.highIntensity = getTime('highIntensityMinutes', 'highIntensitySeconds');
        originalDurations.rest = getTime('restMinutes', 'restSeconds');

        localStorage.setItem('timerSettings', JSON.stringify(originalDurations));

        // Reset phases and update display
        resetPhases();
        currentPhase = phases.warmup.duration > 0 ? 'warmup' : 'highIntensity';
        updateTimerDisplay();
        updateBackgroundColor();

        isPaused = false;
        document.getElementById('pauseButton').textContent = 'Pause';

        closeSettingsModal();
    }

    // Wake lock script (unchanged)
    let wakeLock = null;

    async function requestWakeLock() {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener('release', () => {
                console.log('Wake lock was released');
            });
            console.log('Wake lock is active');
        } catch (err) {
            console.error(`${err.name}, ${err.message}`);
        }
    }
    window.addEventListener('load', requestWakeLock);
    document.addEventListener('visibilitychange', () => {
        if (wakeLock !== null && document.visibilityState === 'visible') {
            requestWakeLock();
        }
    });
    window.addEventListener('unload', () => {
        if (wakeLock !== null) {
            wakeLock.release();
            wakeLock = null;
        }
    });
</script>
</body>
</html>
